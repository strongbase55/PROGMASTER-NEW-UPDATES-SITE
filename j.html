<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPro Academy - Professional Learning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="j.css">
    <link rel="stylesheet" href="nav.css">
</head>

<body>
    <div id="global-loader" aria-hidden="true">
        <div class="loader-box">
            <div class="lds-ring" aria-hidden="true">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div>
                <p>Authenticating ‚Äî Please Wait</p>
                <p style="font-size:12px;color:#6b7280;margin-top:4px">Logging in or registering your account securely...
                </p>
            </div>
        </div>
    </div>

    <nav id="total-nav">
        <div class="logo">
            <img id="white-logo" src="Com Logo.png" alt="">
            <img id="black-logo" src="Com Logo Black.jfif" alt="">
        </div>

        <div class="menu-icon" id="menu-open">
            <i class="fa-solid fa-bars"></i>
        </div>



        <div class="nav-links" id="nav-buttons">
            <button onclick="showWelcomeScreen()" class="nav-link">Home</button>
            <button onclick="showCourseList()" class="nav-link">Courses</button>
            <button onclick="showLogin()" class="nav-link">Login</button>
            <button onclick="showRegister()" class="nav-link">Register</button>
            <button onclick="showAdminLogin()" class="nav-link text-red-600 font-semibold">Admin</button>
        </div>

        <div id="user-nav" class="user-items hidden">
            <div class="flex items-center space-x-1 bg-white rounded-full px-4 py-2 shadow-md">
                <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm font-semibold" id="user-avatar"></span>
                </div>
                <span class="text-gray-700 font-medium" id="user-name-nav"></span>
            </div>
            <button onclick="showDashboard()" class="use bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Dashboard</button>
            <button onclick="showProfile()" id="x-a" class="use bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">My
                        Courses</button>
            <button onclick="showCertificates()" class="use bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">Certificates</button>
            <button onclick="showMyAccount()" class="use bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">My
                        Account</button>

            <button onclick="logout()" class="use bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Logout</button>

            <div class="menu-icon" id="menu-close">
                <i class="fa-solid fa-x"></i>
            </div>
        </div>


        <div id="admin-nav" class="hidden items-center space-x-2">
            <span class="text-sm font-bold text-red-600">Admin Mode</span>
            <button onclick="showAdminDashboard()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Dashboard</button>
            <button onclick="adminLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Logout</button>
        </div>
    </nav>


    <div>
        <div id="welcome-screen" class="fade-in">
            <section class="hero-gradient text-white py-10 px-4 sm:px-6">
                <div class="max-w-7xl mx-auto text-center">
                    <div class="floating mb-8">
                        <div class="inline-block p-4 bg-white bg-opacity-20 rounded-full">
                            <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
                            </svg>
                        </div>
                    </div>
                    <h1 class="text-5xl md:text-7xl font-bold mb-6 slide-in">
                        Transform Your
                        <span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent">Career</span>
                    </h1>
                    <p class="text-xl md:text-2xl mb-8 text-white text-opacity-90 max-w-3xl mx-auto slide-in">
                        Join thousands of professionals mastering cutting-edge skills with our expert-designed courses. Learn at your own pace, earn certificates, and advance your career.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center mb-12 slide-in">
                        <button onclick="showRegister()" class="pulse-glow bg-white text-indigo-600 px-8 py-4 rounded-full text-lg font-semibold hover:bg-gray-100 transition-all duration-300">
                            Start Learning Today
                        </button>
                        <button onclick="showCourseList()" class="border-2 border-white text-white px-8 py-4 rounded-full text-lg font-semibold hover:bg-white hover:text-indigo-600 transition-all duration-300">
                            Explore Courses
                        </button>
                    </div>
                </div>
            </section>

            <section class="py-16 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8 text-center">
                        <div class="stats-counter">
                            <div class="text-4xl font-bold text-indigo-600 mb-2">15+</div>
                            <div class="text-gray-600 font-medium">Expert Courses</div>
                        </div>
                        <div class="stats-counter">
                            <div class="text-4xl font-bold text-purple-600 mb-2">5K+</div>
                            <div class="text-gray-600 font-medium">Students</div>
                        </div>
                        <div class="stats-counter">
                            <div class="text-4xl font-bold text-green-600 mb-2">98%</div>
                            <div class="text-gray-600 font-medium">Success Rate</div>
                        </div>
                        <div class="stats-counter">
                            <div class="text-4xl font-bold text-orange-600 mb-2">24/7</div>
                            <div class="text-gray-600 font-medium">Support</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="py-20 bg-gray-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6">
                    <div class="text-center mb-16">
                        <h2 class="text-4xl font-bold text-gray-800 mb-4">Why Choose PROGMASTER PVT LTD?</h2>
                        <p class="text-xl text-gray-600 max-w-2xl mx-auto">Experience the future of online learning with our innovative platform</p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 md:gap-8">
                        <div class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center">
                            <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-semibold mb-4">Industry-Recognized Certificates</h3>
                            <p class="text-gray-600">Earn certificates that employers value and trust</p>
                        </div>

                        <div class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center">
                            <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z" />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-semibold mb-4">Expert Instructors</h3>
                            <p class="text-gray-600">Learn from industry professionals with real-world experience</p>
                        </div>

                        <div class="card-hover bg-white p-8 rounded-2xl shadow-lg text-center">
                            <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-semibold mb-4">Progress Tracking</h3>
                            <p class="text-gray-600">Monitor your learning journey with detailed analytics</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="py-20 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6">
                    <div class="text-center mb-16">
                        <h2 class="text-4xl font-bold text-gray-800 mb-4">Popular Courses</h2>
                        <p class="text-xl text-gray-600">Start your learning journey with our most popular courses</p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 md:gap-8" id="popular-courses-preview">
                    </div>

                    <div class="text-center mt-12">
                        <button onclick="showCourseList()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:shadow-lg transition-all duration-300">
                            View All Courses
                        </button>
                    </div>
                </div>
            </section>

            <section id="achievements-slider" class="py-12 bg-gradient-to-b from-white to-gray-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Student Achievements</h2>
                        <div class="flex gap-2 items-center">
                            <button id="slide-prev" class="px-3 py-2 rounded-lg bg-gray-100">Prev</button>
                            <button id="slide-next" class="px-3 py-2 rounded-lg bg-gray-100">Next</button>
                        </div>
                    </div>
                    <div id="slider-wrapper" class="overflow-hidden rounded-2xl bg-white shadow-lg">
                        <div id="slider-track" class="flex transition-transform duration-500">
                        </div>
                    </div>
                </div>
            </section>
            <section id="testimonials" class="py-12 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 text-center">
                    <h3 class="text-3xl font-bold mb-4">What our students say</h3>
                    <p class="text-gray-600 mb-8">Real feedback from learners who advanced their careers</p>
                    <div class="grid md:grid-cols-3 gap-6" id="testimonials-list">
                        <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                            <p class="text-gray-700 mb-4">"Great course, practical projects and supportive instructors!"
                            </p>
                            <div class="flex items-center gap-3 justify-center">
                                <div class="w-12 h-12 rounded-full bg-indigo-200 flex items-center justify-center font-semibold">
                                    A</div>
                                <div class="text-left">
                                    <div class="font-bold">Ananya</div>
                                    <div class="text-sm text-gray-500">Full Stack Grad</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                            <p class="text-gray-700 mb-4">"The certificate helped me get interviews. Highly recommend."
                            </p>
                            <div class="flex items-center gap-3 justify-center">
                                <div class="w-12 h-12 rounded-full bg-green-200 flex items-center justify-center font-semibold">
                                    R</div>
                                <div class="text-left">
                                    <div class="font-bold">Ravi</div>
                                    <div class="text-sm text-gray-500">Data Analyst</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                            <p class="text-gray-700 mb-4">"Practical, updated content and friendly community."</p>
                            <div class="flex items-center gap-3 justify-center">
                                <div class="w-12 h-12 rounded-full bg-orange-200 flex items-center justify-center font-semibold">
                                    S</div>
                                <div class="text-left">
                                    <div class="font-bold">Sahana</div>
                                    <div class="text-sm text-gray-500">Mobile Dev</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="contact-section" class="py-12 bg-gradient-to-b from-gray-50 to-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6">
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div>
                            <h3 class="text-3xl font-bold mb-4">Get in touch</h3>
                            <p class="text-gray-600 mb-6">Have questions? Reach out and our team will respond within 24 hours.
                            </p>
                            <ul class="text-gray-700 space-y-3">
                                <li><strong>Email:</strong> support@edupro.example</li>
                                <li><strong>Phone:</strong> +91 98765 43210</li>
                                <li><strong>Address:</strong> 12/4 Tech Park, Hyderabad, India</li>
                            </ul>
                        </div>
                        <div>
                            <form id="contact-form" onsubmit="event.preventDefault(); alert('Thanks ‚Äî we will contact you shortly!'); this.reset();">
                                <div class="mb-3">
                                    <input required placeholder="Your name" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                <div class="mb-3">
                                    <input required type="email" placeholder="Email" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                <div class="mb-3">
                                    <textarea required placeholder="Message" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                                </div>
                                <button class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Send Message</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="admin-login-screen" class="hidden max-w-md mx-auto p-8 rounded-lg shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-center mb-6 text-red-600">Admin Login</h2>
            <p class="text-center text-sm text-gray-600 mb-4">Use: admin@edupro.com / admin123</p>
            <form onsubmit="handleAdminLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Admin Email</label>
                    <input type="email" id="admin-email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" value="admin@edupro.com" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Admin Password</label>
                    <input type="password" id="admin-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" value="admin123" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Login as
                    Admin</button>
            </form>
            <p class="text-center mt-4">
                <button onclick="showWelcomeScreen()" class="text-gray-600 hover:underline">‚Üê Back to Main Page</button>
            </p>
        </div>

        <div id="login-form" class="hidden max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Login</button>
            </form>
            <p class="text-center mt-4">
                Don't have an account?
                <button onclick="showRegister()" class="text-indigo-600 hover:underline">Register here</button>
            </p>
        </div>

        <div id="register-form" class="hidden max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-center mb-6">Register</h2>
            <form onsubmit="handleRegister(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Full Name (Used for Certificate)</label>
                    <input type="text" id="register-name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                    <p class="text-red-500 text-xs mt-1 font-semibold">‚ö†Ô∏è WARNING: Double-check this name! It cannot be changed and will appear on your official certificate.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="register-email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Phone Number (10 Digits)</label>
                    <input type="tel" id="register-phone" pattern="[0-9]{10}" maxlength="10" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="register-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Register</button>
            </form>
            <p class="text-center mt-4">
                Already have an account?
                <button onclick="showLogin()" class="text-green-600 hover:underline">Login here</button>
            </p>
        </div>

        <div id="my-account-screen" class="hidden max-w-4xl mx-auto px-4 sm:px-6 py-8">
            <div class="bg-white rounded-2xl shadow-xl p-8 border-t-4 border-blue-500">
                <h2 class="text-4xl font-bold text-gray-800 mb-6 flex items-center">
                    <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg> My Account Details
                </h2>
                <div id="my-account-details-container" class="space-y-4">
                </div>
            </div>
        </div>
        <div id="dashboard-screen" class="hidden fade-in max-w-7xl px-4 sm:px-6 py-8">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome back, <span id="dashboard-user-name"></span>!
                </h2>
                <p class="text-gray-600">Continue your learning journey</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                <div class="EnrollCourse bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-indigo-100">Enrolled Courses</p>
                            <p class="text-3xl font-bold" id="enrolled-count">0</p>
                        </div>
                        <div class="text-4xl opacity-80">üìö</div>
                    </div>
                </div>

                <div class="CompletedCourse bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100">Completed</p>
                            <p class="text-3xl font-bold" id="completed-count">0</p>
                        </div>
                        <div class="text-4xl opacity-80">üèÜ</div>
                    </div>
                </div>

                <div class="CertificateCourse bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100">Certificates</p>
                            <p class="text-3xl font-bold" id="certificates-count">0</p>
                        </div>
                        <div class="text-4xl opacity-80">üéì</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Continue Learning</h3>
                        <div id="continue-learning" class="space-y-4">
                        </div>
                    </div>
                </div>

                <div>
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <button onclick="showCourseList()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors">
                                Browse Courses
                            </button>
                            <button onclick="showProfile()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors">
                                My Courses
                            </button>
                            <button onclick="showCertificates()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors">
                                View Certificates
                            </button>
                            <button onclick="showNotificationPopup()" class="w-full bg-yellow-500 text-gray-900 py-3 rounded-lg hover:bg-yellow-600 transition-colors relative">
                                Global Notification
                                <span id="notification-badge"
                                    class="absolute top-0 right-0 transform -translate-y-1/2 translate-x-1/2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="course-list" class="hidden fade-in max-w-7xl mx-auto px-4 sm:px-6 py-8">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">All Courses</h2>
                <p class="text-xl text-gray-600">Choose from our comprehensive course catalog</p>
            </div>

            <div class="mb-8 flex justify-center">
                <div class="bg-white rounded-full p-2 shadow-lg">
                    <button onclick="filterCourses('all')" class="language-filter active px-6 py-2 rounded-full transition-all">All</button>
                    <button onclick="filterCourses('programming')" class="language-filter px-6 py-2 rounded-full transition-all">Programming</button>
                    <button onclick="filterCourses('design')" class="language-filter px-6 py-2 rounded-full transition-all">Design</button>
                    <button onclick="filterCourses('business')" class="language-filter px-6 py-2 rounded-full transition-all">Business</button>
                    <button onclick="filterCourses('data')" class="language-filter px-6 py-2 rounded-full transition-all">Data
                        Science</button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-8" id="courses-container"></div>
        </div>

        <div id="certificates-screen" class="hidden fade-in max-w-7xl mx-auto px-4 sm:px-6 py-8">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">My Certificates</h2>
                <p class="text-xl text-gray-600">Your achievements and certifications</p>
            </div>
            <div id="certificates-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            </div>
        </div>

        <div id="course-detail" class="hidden fade-in">
            <button onclick="showCourseList()" class="mb-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">‚Üê
                Back to Courses</button>
            <div id="course-detail-content"></div>
        </div>

        <div id="profile-screen" class="hidden fade-in max-w-7xl mx-auto px-4 sm:px-6 py-8">
            <h2 class="text-3xl font-bold text-center mb-8">My Courses</h2>
            <div id="enrolled-courses" class="flex flex-wrap gap-4 justify-center">
            </div>
        </div>

        <div id="certificate-screen" class="hidden fade-in">
            <div class="max-w-4xl mx-auto">
                <button onclick="showProfile()" class="mb-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">‚Üê
                    Back to My
                    Courses</button>

                <div class="certificate-border-wrapper">
                    <div id="certificate-content" class="certificate-container text-gray-800 text-center relative" style="overflow: hidden;">
                        <div class="watermark"></div>

                    </div>
                </div>
                <div class="text-center mt-6">
                    <button onclick="downloadCurrentCertificate('png')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 text-lg">Download
                        Certificate (PNG)</button>
                    <!-- <button onclick="downloadCurrentCertificate('pdf')"
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 text-lg ml-3">Download
                        Certificate (PDF)</button> -->
                </div>
            </div>
        </div>

        <div id="admin-dashboard-panel" class="hidden fade-in">
            <div class="min-h-screen flex flex-col">
                <header class="bg-white shadow-md z-10">
                    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-gray-900 slide-in">Admin Enrollment Dashboard üîë</h1>
                        <div class="text-sm text-gray-500">
                            Last Refreshed: <span id="last-updated" class="font-semibold text-blue-600">Loading...</span>
                        </div>
                    </div>
                </header>
                <main class="flex-1 p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div id="card-total-students" class="card-animation bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-600">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-medium text-gray-500">Total Student Accounts</div>
                                <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-4h-5v4zm0 0l-1.336-1.336m1.336 1.336H3m3-4H2m3 4v-4m3 4v-4m3 4v-4m3 4v-4m3 4v-4m-3 4V4m3 16V4m-3 0h5m-5 0H3m3 0h12" />
                                </svg>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-1"><span id="metric-total-students">0</span>
                            </p>
                        </div>
                        <div id="card-total-active-users" class="card-animation bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-600">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-medium text-gray-500">Total Active Users</div>
                                <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-1"><span id="metric-total-active-users">0</span></p>
                        </div>
                        <div id="card-total-certificates" class="card-animation bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-600">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-medium text-gray-500">Courses Completed (Certified)</div>
                                <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.01 12.01 0 002.5 14c0 1.491.31 2.923.863 4.264m18.774-11.28A12.01 12.01 0 0021.5 14c0 1.491-.31 2.923-.863 4.264M18 18h-4.264l-.5-1.5-.5 1.5H6m12 0a2 2 0 100 4 2 2 0 000-4z" />
                                </svg>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-1"><span id="metric-total-certificates">0</span></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg card-animation w-full">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Course Enrollment Distribution (Live Data)
                            </h2>
                            <div style="height: 300px;">
                                <canvas id="courseChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg card-animation w-full grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="admin-student-search" class="block text-sm font-medium text-gray-700">Search
                                    Name/Email/Phone</label>
                                <input type="text" id="admin-student-search" placeholder="E.g., Alice Johnson" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 filter-transition">
                            </div>
                            <div>
                                <label for="admin-course-filter" class="block text-sm font-medium text-gray-700">Filter
                                    by Course</label>
                                <select id="admin-course-filter" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 filter-transition bg-white">
                                    <option value="all">All Courses</option>
                                </select>
                            </div>
                            <div>
                                <label for="admin-status-filter" class="block text-sm font-medium text-gray-700">Filter
                                    by Enrollment Status</label>
                                <select id="admin-status-filter" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 filter-transition bg-white">
                                    <option value="all">Any Status</option>
                                    <option value="true">Active (True)</option>
                                    <option value="false">Pending (False)</option>
                                </select>
                            </div>
                            <div>
                                <label for="admin-online-filter" class="block text-sm font-medium text-gray-700">Filter
                                    by Online Status</label>
                                <select id="admin-online-filter" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 filter-transition bg-white">
                                    <option value="all">All</option>
                                    <option value="online">Online</option>
                                    <option value="offline">Offline</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg card-animation">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">
                            Student Enrollment Records
                            <span id="approval-metrics" class="ml-4 text-sm font-normal text-gray-600">
                                (Active: <span id="metric-approvals" class="font-semibold text-green-600">0</span> / Pending: <span id="metric-revokes" class="font-semibold text-orange-600">0</span>)
                            </span>
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Course Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                            <div id="admin-no-results" class="hidden text-center py-8 text-gray-500">No enrollment records found matching the criteria.</div>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <div class="flex space-x-2">
                                <button onclick="handlePagination('prev')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition-colors hidden" id="prev-page-btn">‚Üê</button>
                                <button onclick="handlePagination('next')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition-colors hidden" id="next-page-btn">‚Üí</button>
                            </div>
                            <span class="text-sm text-gray-600" id="pagination-info">Displaying 0 records</span>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="admin-user-details-modal" class="modal hidden">
        <div class="modal-content w-full max-w-xl admin-profile-card">
            <div class="flex justify-between items-center pb-4 mb-4 border-b border-indigo-200">
                <h2 class="text-3xl font-extrabold text-indigo-900" id="modal-user-name">Student Details</h2>
                <button onclick="closeAdminUserDetails()" class="text-gray-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div id="modal-user-info" class="p-4 bg-indigo-50 rounded-xl shadow-inner mb-6 space-y-2 text-gray-700">
            </div>

            <div class="mt-6 flex justify-between space-x-3 pt-4">
                <button id="disable-user-btn" onclick="toggleUserDisableStatus(document.getElementById('admin-user-details-modal').getAttribute('data-user-id'))" class="bg-yellow-500 text-gray-900 px-4 py-2 rounded-lg text-sm hover:bg-yellow-600 transition-colors flex-1 shadow-md">Disable
                    User</button>
                <button id="delete-user-btn" onclick="deleteUserPermanently(document.getElementById('admin-user-details-modal').getAttribute('data-user-id'))" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition-colors flex-1 shadow-md">Delete
                    User Permanently</button>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4 flex items-center">
                    <span class="mr-2 text-indigo-600">üìö</span> Enrolled Courses (<span id="modal-enrolled-count">0</span>)
                </h3>
                <div id="modal-course-list" class="space-y-3">
                </div>
            </div>
        </div>
    </div>
    <div id="notification-modal" class="modal hidden">
        <div class="modal-content w-full max-w-lg bg-white p-6 rounded-xl shadow-2xl border-t-8 border-yellow-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <span class="mr-3 text-yellow-600">üì¢</span> Global Announcement
                </h2>
                <button onclick="closeNotificationPopup()" class="text-gray-500 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div id="notification-content" class="bg-yellow-50 p-4 rounded-lg text-yellow-900 border border-yellow-200">
                <p class="font-medium text-lg">No active announcements.</p>
            </div>
            <p class="text-xs text-gray-500 mt-4 text-right">Last updated: <span id="notification-timestamp">N/A</span>
            </p>
        </div>
    </div>

    <div id="course-wrapper" class="hidden fixed inset-0 w-full h-full bg-white z-[999] flex flex-col overflow-hidden">

        <!-- NAVBAR -->
        <nav class="bg-gray-800 p-3 text-white shadow-lg flex justify-between items-center z-10">

            <!-- LEFT -->
            <div class="flex items-center gap-3">
                <span class="text-lg font-bold">PROGMASTER Learning</span>
                <span id="integrated-course-title" class="text-sm text-gray-500"></span>
            </div>

            <!-- RIGHT FOR DESKTOP -->
            <div class="hidden md:flex items-center gap-3">
                <button id="integrated-completion-button" class="bg-gray-300 text-white font-semibold py-2 px-4 rounded-lg transition
                       disabled:opacity-50 disabled:cursor-not-allowed">
                Loading...
            </button>

                <button onclick="endLearningSession()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4
                       rounded-lg transition">
                ‚Üê Dashboard
            </button>
            </div>

            <!-- MOBILE MENU BUTTON (3 dots) -->
            <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg border border-white-300 text-white-1000">
            ‚ãÆ
        </button>
        </nav>

        <!-- MOBILE MENU DROPDOWN -->
        <div id="mobile-menu" class="hidden md:hidden absolute right-4 top-16 bg-white shadow-lg rounded-lg border p-3 space-y-2 z-[9999]">

            <button id="integrated-completion-button-mobile" class="bg-gray-300 w-full text-white font-semibold py-2 px-4 rounded-lg transition
                   disabled:opacity-50 disabled:cursor-not-allowed">
            Loading...
        </button>

            <button onclick="endLearningSession()" class="bg-indigo-600 hover:bg-indigo-700 w-full text-white font-semibold py-2 px-4
                   rounded-lg transition">
            ‚Üê Dashboard
        </button>
        </div>

        <!-- IFRAME -->
        <iframe id="integrated-course-iframe" class="flex-grow w-full h-full border-none"></iframe>

        <!-- LOADING SCREEN -->
        <div id="integrated-loading-screen" class="absolute inset-0 flex flex-col items-center justify-center
                bg-white/90 backdrop-blur-sm">

            <h1 class="text-3xl font-bold text-indigo-600 mb-3">Validating Session...</h1>
            <p class="text-gray-600 text-lg">Preparing course environment securely</p>
        </div>
    </div>

    <script>
        // MOBILE MENU TOGGLE
        const mobileBtn = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");

        mobileBtn.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
        });

        // Sync completion button
        const desktopBtn = document.getElementById("integrated-completion-button");
        const mobileBtnCompletion = document.getElementById("integrated-completion-button-mobile");

        // Mirror button state (loading/completed)
        const observer = new MutationObserver(() => {
            mobileBtnCompletion.textContent = desktopBtn.textContent;
            mobileBtnCompletion.disabled = desktopBtn.disabled;
        });

        observer.observe(desktopBtn, {
            attributes: true,
            childList: true
        });
    </script>

    <script>
        // Application State
        let currentCourse = null;
        let currentDay = 1;
        let currentUser = null;
        const PAYMENT_LINK = 'https://rzp.io/rzp/MdrDDje';
        let isAdminLoggedIn = false;
        const ADMIN_EMAIL = 'admin@edupro.com';
        const ADMIN_PASSWORD = 'admin123';
        let courseChartInstance = null;

        // Pagination state
        const RECORDS_PER_PAGE = 20;
        let currentPage = 1;

        // --- NEW INTEGRATION VARIABLES ---
        const MINIMUM_TIME_SECONDS = 30; // Set to 30 for testing (5 min = 300)
        let integratedCompletionTimer = null;
        let currentLearningUserId = null;
        let currentLearningCourseId = null;
        // --- END NEW INTEGRATION VARIABLES ---

        // Sample Data: COURSE IDs must be unique strings 
        let courses = [{
            id: "web_dev",
            title: "Full Stack Web Development",
            description: "Master modern web development with React, Node.js, and databases",
            duration: "10 days",
            level: "Beginner",
            icon: "üíª",
            category: "programming",
            rating: 4.9,
            students: 2847,
            curriculum: [{
                title: "HTML",
                day: 1
            }, {
                title: "CSS",
                day: 2
            }, {
                title: "JS",
                day: 3
            }, {
                title: "React",
                day: 4
            }, {
                title: "Node",
                day: 5
            }, {
                title: "Express",
                day: 6
            }, {
                title: "DB",
                day: 7
            }, {
                title: "API",
                day: 8
            }, {
                title: "Auth",
                day: 9
            }, {
                title: "Deploy",
                day: 10
            }]
        }, {
            id: "aws_cloud",
            title: "Cloud Computing with AWS",
            description: "Master Amazon Web Services and cloud architecture",
            duration: "10 days",
            level: "Intermediate",
            icon: "‚òÅÔ∏è",
            category: "programming",
            rating: 4.8,
            students: 2156,
            curriculum: [{
                title: "Cloud Funda",
                day: 1
            }, {
                title: "EC2",
                day: 2
            }, {
                title: "S3",
                day: 3
            }, {
                title: "RDS",
                day: 4
            }, {
                title: "Lambda",
                day: 5
            }, {
                title: "CF",
                day: 6
            }, {
                title: "IAM",
                day: 7
            }, {
                title: "Monitor",
                day: 8
            }, {
                title: "DevOps",
                day: 9
            }, {
                title: "Cert Prep",
                day: 10
            }]
        }];

        const firebaseConfig = {
            apiKey: "AIzaSyBnQ0s1jFoMH6J7vhKVM7NVC-WNScLdA7E",
            authDomain: "sutherland-6ce2b.firebaseapp.com",
            databaseURL: "https://sutherland-6ce2b-default-rtdb.firebaseio.com",
            projectId: "sutherland-6ce2b",
            storageBucket: "sutherland-6ce2b.firebasestorage.app",
            messagingSenderId: "243800407888",
            appId: "1:243800407888:web:2c4dfa1e6a267ba2a17655",
            measurementId: "G-S6GMQ32JJ5"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Data Storage
        let users = [];
        let certificates = [];
        let globalNotification = null;
        let currentUserId = null;


        // **************************************************
        // *** 0. CORE UTILITY FUNCTIONS (MUST BE DEFINED FIRST) ***
        // **************************************************


        function showLoader() {
            document.getElementById("global-loader").style.display = "flex";
        }

        function hideLoader() {
            document.getElementById("global-loader").style.display = "none";
        }

        function getCourseTitle(courseId) {
            const course = courses.find(c => c.id === courseId);
            return course ? course.title : 'Unknown Course';
        }

        function isUserOnline(lastActiveTimestamp) {
            if (!lastActiveTimestamp) return false;
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            return lastActiveTimestamp > fiveMinutesAgo;
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');

            if (!currentUser || !globalNotification || !globalNotification.timestamp) {
                badge.classList.add('hidden');
                return;
            }

            const lastCheck = currentUser.last_notification_check || 0;

            if (globalNotification.timestamp > lastCheck) {
                badge.textContent = 'New!';
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function getCourseEnrollmentDistributionData() {
            const enrollmentMap = {};
            courses.forEach(course => {
                enrollmentMap[course.id] = {
                    enrolled: 0,
                    certified: 0,
                    title: course.title
                };
            });

            let totalApprovals = 0;
            let totalRevokes = 0;
            let totalActiveUsers = 0;

            users.forEach(user => {
                const userEnrollments = user.enrolled_courses || {};
                Object.keys(userEnrollments).forEach(courseId => {
                    if (enrollmentMap[courseId]) {
                        enrollmentMap[courseId].enrolled++;
                        if (userEnrollments[courseId].status === true) {
                            totalApprovals++;
                        } else {
                            totalRevokes++;
                        }
                    }
                });

                if (!user.disabled && isUserOnline(user.last_active)) {
                    totalActiveUsers++;
                }
            });

            certificates.forEach(cert => {
                if (enrollmentMap[cert.courseId]) {
                    enrollmentMap[cert.courseId].certified++;
                }
            });

            return {
                labels: Object.values(enrollmentMap).map(d => d.title),
                enrolledData: Object.values(enrollmentMap).map(d => d.enrolled),
                certifiedData: Object.values(enrollmentMap).map(d => d.certified),
                totalApprovals,
                totalRevokes,
                totalActiveUsers
            };
        }


        // **************************************************
        // *** 1. SCREEN NAVIGATION FUNCTIONS ***
        // **************************************************

        function hideAllScreens() {
            ['welcome-screen', 'login-form', 'register-form', 'dashboard-screen', 'course-list', 'course-detail', 'profile-screen', 'certificate-screen', 'certificates-screen', 'admin-dashboard-panel', 'admin-login-screen', 'admin-user-details-modal', 'my-account-screen', 'notification-modal', 'course-wrapper'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
        }

        function updateNav(isLoggedIn, isAdmin) {
            const navButtons = document.getElementById('nav-buttons');
            const userNav = document.getElementById('user-nav');
            const adminNav = document.getElementById('admin-nav');
            const totalNav = document.getElementById('total-nav');
            const blackLogo = document.getElementById('black-logo');
            const whiteLogo = document.getElementById('white-logo');

            navButtons.style.display = 'none';
            userNav.style.display = 'none';
            adminNav.style.display = 'none';

            if (isAdmin) {
                adminNav.style.display = 'flex';
            } else if (isLoggedIn) {
                if (currentUser) {
                    document.getElementById('user-name-nav').textContent = currentUser.name.split(' ')[0];
                    document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
                    updateNotificationBadge(); // Defined above
                }
                userNav.style.display = 'flex';
                blackLogo.style.display = 'block';
                whiteLogo.style.display = 'none';
                totalNav.style.backgroundColor = 'white';
                document.getElementById('welcome-screen').style.display = 'none';
                showDashboard();


            } else {
                navButtons.style.display = 'flex';
                blackLogo.style.display = 'none';
                whiteLogo.style.display = 'block';
                totalNav.style.backgroundColor = 'black';

            }
        }

        // FIX: Moved Admin Login Functions Here
        function showAdminLogin() {
            hideAllScreens();
            document.getElementById('admin-login-screen').style.display = 'block';
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            updateNav(false, false);
            showWelcomeScreen();
        }


        function showWelcomeScreen() {
            hideAllScreens();
            isAdminLoggedIn = false;
            updateNav(false, false);
            document.getElementById('welcome-screen').style.display = 'block';
            document.getElementById('user-nav').style.display = 'none';

        }

        function showLogin() {
            hideAllScreens();
            document.getElementById('login-form').style.display = 'block';
        }

        function showRegister() {
            hideAllScreens();
            document.getElementById('register-form').style.display = 'block';
        }

        function showCourseList() {
            hideAllScreens();
            document.getElementById('course-list').style.display = 'block';
            renderCourseList(courses);
            resetFilterButtons('all');
        }

        // Final screen functions must call rendering functions defined below
        async function showDashboard() {
            if (!currentUserId) return showLogin();
            await fetchUserData();

            if (currentUserId) {
                database.ref(`edupro_users/${currentUserId}/last_active`).set(Date.now());
            }

            hideAllScreens();
            document.getElementById('dashboard-screen').style.display = 'block';
            renderDashboard(); // Defined below
        }
        async function showCertificates() {
            if (!currentUserId) return showLogin();
            await fetchUserData();

            hideAllScreens();
            document.getElementById('certificates-screen').style.display = 'block';
            renderCertificates(); // Defined below
        }

        function showProfile() {
            if (!currentUserId) return showLogin();
            fetchUserData().then(() => {
                hideAllScreens();
                document.getElementById('profile-screen').style.display = 'block';
                renderProfileCourses(); // Defined below
            });
        }
        async function showMyAccount() {
            if (!currentUserId) return showLogin();
            await fetchUserData();

            hideAllScreens();
            document.getElementById('my-account-screen').style.display = 'block';
            renderMyAccount(); // Defined below
        }

        function openExistingCertificate(certObj) {
            showCertificateScreen(certObj);
        }

        function showCertificateScreen(certData) {
            hideAllScreens();
            document.getElementById('certificate-screen').style.display = 'block';
            renderCertificate(certData); // Defined below
        }
        async function showNotificationPopup() {
            if (!currentUserId || !currentUser) return showLogin();
            const modal = document.getElementById('notification-modal');
            const content = document.getElementById('notification-content');
            const timestampDisplay = document.getElementById('notification-timestamp');

            await fetchUserData();

            if (globalNotification && globalNotification.message) {
                content.innerHTML = `<p class="font-medium text-lg">${globalNotification.message}</p>`;
                timestampDisplay.textContent = new Date(globalNotification.timestamp).toLocaleString();
            } else {
                content.innerHTML = `<p class="font-medium text-lg">No active announcements.</p>`;
                timestampDisplay.textContent = 'N/A';
            }

            if (globalNotification && globalNotification.timestamp) {
                await database.ref(`edupro_users/${currentUserId}/last_notification_check`).set(globalNotification.timestamp);
                currentUser.last_notification_check = globalNotification.timestamp;
                updateNotificationBadge();
            }

            modal.style.display = 'flex';
        }

        function closeNotificationPopup() {
            document.getElementById('notification-modal').style.display = 'none';
        }
        async function showAdminDashboard() {
            if (!isAdminLoggedIn) return showAdminLogin();
            currentPage = 1;
            hideAllScreens();
            document.getElementById('admin-dashboard-panel').style.display = 'block';
            await fetchUserData();
            renderAdminDashboard(); // Defined below
        }

        // *** INTEGRATED COURSE LEARNING FUNCTIONS ***

        async function secureStartLearning(courseId) {
            if (!currentUserId) return showLogin();

            const course = courses.find(c => c.id === courseId);
            const userEnrollment = currentUser.enrolled_courses ? currentUser.enrolled_courses[courseId] : null;

            if (!userEnrollment || userEnrollment.status !== true) {
                alert("Course not yet unlocked. Please check your payment status");
                showCourseDetail(courseId);
                return;
            }

            try {
                // Set global state for the learning session
                currentLearningUserId = currentUserId;
                currentLearningCourseId = courseId;

                // Display the course wrapper and loading screen
                hideAllScreens();
                document.getElementById('course-wrapper').style.display = 'flex';
                document.getElementById('integrated-loading-screen').style.display = 'flex';
                document.getElementById('integrated-loading-screen').style.opacity = 1;

                // Update UI
                document.getElementById('integrated-course-title').textContent = `Course: ${course.title}`;
                document.getElementById('integrated-loading-screen').innerHTML = `
                    <h1 class="text-3xl font-bold text-indigo-600 mb-4">Preparing Course...</h1>
                    <p class="text-gray-600">Loading module content securely.</p>
                `;

                // 1. Load the course content into the iframe
                const iframe = document.getElementById('integrated-course-iframe');
                iframe.src = `courses/${courseId}/index.html`;

                // Wait a moment for the iframe to load and hide the initial loading screen
                iframe.onload = () => {
                    document.getElementById('integrated-loading-screen').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('integrated-loading-screen').style.display = 'none';
                    }, 600);
                    startCompletionTimer(); // Start the timer when the content is ready
                };

            } catch (error) {
                console.error("In-page Course Load Error:", error);
                alert("Failed to load course content. Redirecting to dashboard.");
                hideLoader();
                showDashboard();
            }
        }

        function startLearning(courseId) {
            if (!currentUserId || !currentUser) return showLogin();
            secureStartLearning(courseId);
        }

        function startCompletionTimer() {
            let remainingSeconds = MINIMUM_TIME_SECONDS;
            const completionButton = document.getElementById('integrated-completion-button');

            const updateTime = () => {
                if (remainingSeconds <= 0) {
                    clearInterval(integratedCompletionTimer);
                    enableCompletionButton();
                    return;
                }

                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                completionButton.textContent = `Finish Course (Wait ${timeString})`;
                remainingSeconds--;
            };

            completionButton.disabled = true;
            completionButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            completionButton.classList.add('bg-gray-400');
            updateTime();
            integratedCompletionTimer = setInterval(updateTime, 1000);
        }
        // Old logic in enableCompletionButton:
        /*
                    completionButton.onclick = () => {
                        if (confirm("Are you sure you want to finish the course and generate your certificate? This action cannot be undone.")) {
                            // ... loading screen ...
                            generateAndSaveCertificateAndRedirect(currentLearningUserId, currentLearningCourseId);
                        }
                    };
        */

        // New logic for enableCompletionButton (Requires minor async update to check):
        async function enableCompletionButton() {
            let remainingSeconds = MINIMUM_TIME_SECONDS;
            const completionButton = document.getElementById('integrated-completion-button');
            const courseId = currentLearningCourseId;
            const userId = currentLearningUserId;

            // 1. Initial Check: If already certified, set button to disabled status and exit.
            // This check is good but needs to be performed on fresh data (handled by fetch in onclick)
            await fetchUserData(true);
            const isCertified = certificates.some(c => c.userId === userId && c.courseId === courseId);

            if (isCertified) {
                completionButton.textContent = "Certified! View Certificate üèÜ";
                completionButton.disabled = false;
                completionButton.classList.remove('bg-green-600', 'txt-color:black',
                    'hover:bg-green-700', 'bg-gray-400');
                completionButton.classList.add('bg-yellow-500');
                completionButton.onclick = () => showCertificates();
                return;

            }

            // 2. Button setup for first completion
            completionButton.textContent = "Finish Course & Get Certificate üèÜ";
            completionButton.disabled = false;
            completionButton.classList.remove('bg-gray-400');
            completionButton.classList.add('bg-green-600', 'hover:bg-green-700');

            completionButton.onclick = async() => {
                // *** CRITICAL FIX 1: IMMEDIATELY DISABLE THE BUTTON UPON FIRST CLICK ***
                completionButton.disabled = true;
                completionButton.textContent = "Processing...";
                completionButton.classList.remove('bg-green-600');
                completionButton.classList.add('bg-gray-400');

                try {
                    // Re-fetch data inside the click handler for the most current state (Race condition protection)
                    await fetchUserData(true);
                    const alreadyCertified = certificates.some(c => c.userId === userId && c.courseId === courseId);

                    if (alreadyCertified) {
                        alert("Certificate is already generated for this course. Redirecting to your certificates.");
                        endLearningSession();
                        showCertificates();
                        return;
                    }

                    if (confirm("Are you sure you want to finish the course and generate your certificate? This action cannot be undone.")) {

                        // *** CRITICAL FIX 2: SHOW VISUAL LOADER AND GLOBAL LOADER ***
                        document.getElementById('integrated-loading-screen').style.display = 'flex';
                        document.getElementById('integrated-loading-screen').style.opacity = 1;
                        document.getElementById('integrated-loading-screen').innerHTML = `
                    <h1 class="text-3xl font-bold text-green-600 mb-4">Course Completed!</h1>
                    <p class="text-gray-700">Generating your official certificate...</p>
                    <div class="lds-ring" style="margin-top:20px"><div></div><div></div><div></div><div></div></div>
                `;
                        showLoader(); // Show the global "Authenticating" loader

                        await generateAndSaveCertificateAndRedirect(currentLearningUserId, currentLearningCourseId);
                    } else {
                        // If the user cancels the confirmation, re-enable the button
                        enableCompletionButton();
                    }
                } catch (e) {
                    console.error("Certificate generation failed:", e);
                    alert("An error occurred during certificate generation. Please try again.");
                    // Ensure button is restored if an error occurs before final redirection
                    enableCompletionButton();
                    hideLoader();
                }
            };
        }

        function endLearningSession() {
            if (integratedCompletionTimer) clearInterval(integratedCompletionTimer);
            document.getElementById('integrated-course-iframe').src = 'about:blank';
            document.getElementById('course-wrapper').style.display = 'none';

            currentLearningUserId = null;
            currentLearningCourseId = null;

            hideLoader();
            showDashboard();
        }

        // *** END SCREEN NAVIGATION ***


        // **************************************************
        // *** 2. CORE CERTIFICATE LOGIC ***
        // **************************************************

        async function generateAndSaveCertificate(uid, courseId) {
            try {
                if (!firebase || !firebase.database) throw new Error('Firebase not available');

                await fetchUserData(true);

                const user = users.find(u => u.uid === uid) || {};
                const course = courses.find(c => c.id === courseId);

                if (!user || !course) throw new Error('User or Course data missing for certificate generation.');

                const existingCert = certificates.find(c => c.userId === uid && c.courseId === courseId);
                if (existingCert) {
                    console.warn(`Certificate already exists for user ${uid} and course ${courseId}. Skipping generation.`);
                    return existingCert;
                }

                const userEnrollment = user.enrolled_courses ? user.enrolled_courses[courseId] : {};
                const completed = course.curriculum ? course.curriculum.length : 10;
                const total = completed;

                const counterRef = firebase.database().ref('/meta/certificateCounter');
                const counterResult = await counterRef.transaction(current => (current || 0) + 1);
                const count = (counterResult.snapshot && counterResult.snapshot.val()) || 1;
                const refNo = 'PROG' + String(count).padStart(2, '0');

                const dateIssued = new Date();
                const certName = user.name || 'Student Name';

                const certObj = {
                    name: certName,
                    userId: uid,
                    courseId: courseId,
                    courseTitle: course.title,
                    completedModules: completed,
                    totalModules: total,
                    refNo: refNo,
                    dateIssued: dateIssued.toISOString(),
                    dateDisplay: (function(d) {
                        const dd = String(d.getDate()).padStart(2, '0');
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        return dd + '.' + mm + '.' + d.getFullYear();
                    })(dateIssued),
                    id: refNo
                };

                await firebase.database().ref(`certificates/${refNo}`).set(certObj);
                certificates.push(certObj);

                return certObj;
            } catch (err) {
                console.error('generateAndSaveCertificate error', err);
                throw err;
            }
        }

        async function generateAndSaveCertificateAndRedirect(uid, courseId) {
            try {
                await fetchUserData(true);

                const userToCertify = users.find(u => u.uid === uid);

                if (!userToCertify) {
                    hideLoader(); // Essential fix: hide loader on error
                    console.error("CERT GENERATION ERROR: User data not found locally after refresh for UID:", uid);
                    throw new Error("User data is unavailable for certificate generation.");
                }

                // Check 2: Final critical check (Prevents race condition duplicates)
                const existingCert = certificates.find(c => c.userId === uid && c.courseId === courseId);

                if (existingCert) {
                    hideLoader(); // Essential fix: hide loader before alert
                    alert(`Certificate for ${existingCert.courseTitle} already exists. Redirecting to Certificates page.`);
                    await fetchUserData();
                    showCertificates();
                    return;
                }

                // Proceed with generation only if it doesn't exist
                const certObj = await generateAndSaveCertificate(uid, courseId);

                // ... existing logic to set day and fetch data ...
                const total = certObj.totalModules;
                await database.ref(`edupro_users/${uid}/enrolled_courses/${courseId}/day`).set(total);

                await fetchUserData();

                hideLoader(); // <<< IMPORTANT: HIDE GLOBAL LOADER AFTER SUCCESSFUL PROCESS
                alert(`Congratulations! Certificate ${certObj.refNo} generated for ${certObj.courseTitle}.`);
                showCertificates();

            } catch (error) {
                console.error("Certificate Generation/Redirect Failed at final step:", error);

                hideLoader(); // <<< IMPORTANT: HIDE GLOBAL LOADER ON CRITICAL ERROR
                alert("CRITICAL ERROR: Certificate failed to generate or save. Please check console for details. Redirecting to dashboard.");
                showDashboard();
            }
        }

        function renderCertificate(certData) {
            if (!certData) return;
            const container = document.getElementById('certificate-content');
            if (!container) return;

            const course = courses.find(c => c.id === certData.courseId) || {};
            const userName = certData.name || 'Student Name';
            const completed = certData.completedModules || 10;
            const total = certData.totalModules || 10;
            const refNo = certData.refNo || 'PROG00';
            const dateDisplay = certData.dateDisplay || (new Date().toISOString().split('T')[0]);

            // Base64 SVGs/Images (Placeholders - restore original data here for PDF/PNG download to work)
            const companyLogoSVG = '';
            const aicteLogoSVG = '';
            const sealSVG = '';
            const signatureSVG_1 = '';
            const signatureSVG_2 = '';


            container.setAttribute('data-course-id', certData.courseId || '');
            container.setAttribute('data-course-title', course.title || certData.courseTitle || '');
            container.setAttribute('data-user-name', userName || '');
            container.setAttribute('data-ref', refNo);

            container.innerHTML = `
                <div style="padding:10px;">
                <div class="certificate-inner-content" style="width:100%;background:linear-gradient(180deg,#fff,#fcf9f8);border-radius:12px;padding:28px;font-family: 'Merriweather', serif;">
                    
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="display:flex;align-items:center;gap:16px">
                        <div style="width:96px;height:96px;border-radius:12px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center;border:2px solid #eee;">
                        <img src="${companyLogoSVG}" alt="Company Logo" style="width:100%;height:100%;object-fit:cover;">
                        </div>
                        <div>
                        <div style="font-size:20px;color:#6a1b1b;font-weight:900">ProgMaster Pvt Ltd</div>
                        <div style="color:#6b6b6b;margin-top:6px">is proud to certify</div>
                        </div>
                    </div>
                    <div style="text-align:right;color:#6b6b6b;font-size:13px">
                        <img src="${aicteLogoSVG}" alt="AICTE Logo" style="width:96px;height:96px;object-fit:cover;border-radius:12px;border:2px solid #eee;">
                    </div>
                    <br>
                                        <div style="text-align:right;color:#6b6b6b;font-size:13px">
                        <img src="${aicteLogoSVG}" alt="AICTE Logo" style="width:96px;height:96px;object-fit:cover;border-radius:12px;border:2px solid #eee;">
                    </div>         <div style="text-align:right;color:#6b6b6b;font-size:13px">
                        <img src="${aicteLogoSVG}" alt="AICTE Logo" style="width:96px;height:96px;object-fit:cover;border-radius:12px;border:2px solid #eee;">
                    </div>
                    </div>

                    <div style="text-align:center;margin-top:20px">
                    <div style="font-size:30px;color:#6a1b1b;font-weight:900;letter-spacing:2px">COURSE COMPLETION CERTIFICATE</div>
                    <div style="margin-top:8px;color:#6b6b6b">This Certificate Is Proudly Presented To</div>
                    <div style="font-size:36px;color:#6a1b1b;font-weight:800;margin-top:12px">${(userName || '').toUpperCase()}</div>
                    <div style="height:2px;background:linear-gradient(90deg,#6a1b1b,#a64b4b);margin:18px auto;width:80%;border-radius:2px"></div>
                    <div style="max-width:760px;margin:0 auto;color:#575757">
                        For successfully completing the
                        <strong style="color:#222">${course.title || certData.courseTitle || 'Web Development'}</strong> course at <strong style="color:#222">PROGMASTER PRIVATE LIMITED</strong>
                    </div>
                    </div>

                    <div style="display:flex;justify-content:space-between;margin-top:28px;padding:0 12px;color:#444">
                    <div>
                        <div style="font-size:12px;color:#6b6b6b">Course Progress</div>
                        <div style="font-weight:700;margin-top:6px">${completed}/${total}</div>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:12px;color:#6b6b6b">Course Points (Fixed)</div>
                        <div style="font-weight:700;margin-top:6px">100/100</div>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:12px;color:#6b6b6b">Reference Number</div>
                        <div style="font-weight:700;margin-top:6px">${refNo}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:12px;color:#6b6b6b">Date Of Issue</div>
                        <div style="font-weight:700;margin-top:6px">${dateDisplay}</div>
                    </div>
                    </div>

                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:36px;padding:0 12px">
                    <div style="text-align:center">
                        <img src="${signatureSVG_1}" alt="Signature Jai Hemi" style="height:50px;width:150px;border-bottom:1px solid #6a1b1b;">
                        <div style="font-weight:700;color:#222;margin-top:4px">Jai Hemi</div>
                        <div style="font-size:12px;color:#6b6b6b">Lead Instructor</div>
                    </div>
                    <div style="text-align:center">
                        <img src="${sealSVG}" alt="Authorized Seal" style="width:100px;height:100px;margin:0 auto;border-radius:999px;">
                        <div style="font-size:12px;color:#6b6b6b">Authorized Seal</div>
                    </div>
                    <div style="text-align:center">
                        <img src="${signatureSVG_2}" alt="Signature Samuel Runittu" style="height:50px;width:150px;border-bottom:1px solid #6a1b1b;">
                        <div style="font-weight:700;color:#222;margin-top:4px">Samuel Runittu</div>
                        <div style="font-size:12px;color:#6b6b6b">Program Director</div>
                    </div>
                    </div>

                </div>
                </div>
            `;
        }

        // **************************************************
        // *** 3. CORE APPLICATION LOGIC ***
        // **************************************************

        function handlePagination(direction) {
            if (direction === 'next') {
                currentPage++;
            } else if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            }
            renderAdminStudentTable();
        }

        function initializeUI() {
            fetchUserData(true).then(() => {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        if (user.email === ADMIN_EMAIL && user.uid === 'admin-mock-uid') {} else {
                            currentUserId = user.uid;
                            fetchUserData().then(() => {
                                updateNav(true, false);
                                if (document.getElementById('welcome-screen').style.display !== 'none' ||
                                    document.getElementById('login-form').style.display !== 'none' ||
                                    document.getElementById('register-form').style.display !== 'none'
                                ) {
                                    if (document.getElementById('certificate-screen').style.display === 'none') {
                                        hideLoader();
                                        showDashboard();
                                    }
                                }
                            });
                        }
                    } else {
                        currentUserId = null;
                        currentUser = null;
                        updateNav(false, isAdminLoggedIn);
                        if (!isAdminLoggedIn) {
                            if (document.getElementById('dashboard-screen').style.display === 'block' ||
                                document.getElementById('profile-screen').style.display === 'block' ||
                                document.getElementById('certificates-screen').style.display === 'block' ||
                                document.getElementById('my-account-screen').style.display === 'block' ||
                                document.getElementById('course-wrapper').style.display === 'flex'
                            ) {
                                showWelcomeScreen();
                            }
                        }
                    }
                });

                loadPopularCourses();
            });
        }

        async function fetchUserData(loadCoursesData = false) {
            try {
                if (loadCoursesData) {
                    const courseSnapshot = await database.ref('edupro_courses').once('value');
                    const dbCourses = courseSnapshot.val();

                    if (dbCourses && Array.isArray(dbCourses) && dbCourses.length > 0) {
                        courses = dbCourses;
                        loadPopularCourses();
                    }
                }

                const userSnapshot = await database.ref('edupro_users').once('value');
                users = userSnapshot.val() ? Object.keys(userSnapshot.val()).map(uid => ({
                    uid,
                    ...userSnapshot.val()[uid]
                })) : [];
                currentUser = users.find(u => u.uid === currentUserId);

                const certificateSnapshot = await database.ref('certificates').once('value');
                certificates = certificateSnapshot.val() ? Object.values(certificateSnapshot.val()) : [];

                const notificationSnapshot = await database.ref('edupro_notifications').once('value');
                const rawNotification = notificationSnapshot.val();
                const tenDaysAgo = Date.now() - (10 * 24 * 60 * 60 * 1000);
                if (rawNotification && rawNotification.timestamp < tenDaysAgo) {
                    await database.ref('edupro_notifications').remove();
                    globalNotification = null;
                } else {
                    globalNotification = rawNotification;
                }
                const currentGlobalNotificationEl = document.getElementById('current-global-notification');

                if (globalNotification && currentGlobalNotificationEl) {
                    currentGlobalNotificationEl.textContent = globalNotification.message;
                } else if (currentGlobalNotificationEl) {
                    currentGlobalNotificationEl.textContent = 'None (Cleared)';
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // **************************************************
        // *** 4. AUTH & DB HANDLERS ***
        // **************************************************

        async function handleAdminLogin(event) {
            event.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                updateNav(false, true);
                showAdminDashboard();
            } else {
                alert("Invalid Admin Credentials.");
            }
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            updateNav(false, false);
            showWelcomeScreen();
        }

        async function handleLogin(event) {
            showLoader();
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await fetchUserData();
                const userToLogin = users.find(u => u.email === email);

                if (userToLogin && userToLogin.disabled === true) {
                    alert("Account is temporarily disabled by the administrator. Please contact support.");
                    return;
                }

                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (userCredential.user.uid) {
                    database.ref(`edupro_users/${userCredential.user.uid}/last_active`).set(Date.now());
                }
            } catch (error) {
                alert(`Login Failed: ${error.message}`);
            }
        }

        async function handleRegister(event) {
            showLoader();
            event.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            const password = document.getElementById('register-password').value;

            try {
                const nameWarning = `
                    ‚ö†Ô∏è WARNING ‚ö†Ô∏è
                    The name provided ("${name}") will be used EXCLUSIVELY for your official certificate.
                    It cannot be changed later. 
                    
                    Click OK to confirm your name and continue registration.
                `;
                if (!window.confirm || !window.confirm(nameWarning)) {
                    alert(nameWarning + "\nRegistration CANCELLED.");
                    return;
                }

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                await database.ref('edupro_users/' + uid).set({
                    name: name,
                    email: email,
                    phone: phone,
                    joined: new Date().toISOString().split('T')[0],
                    disabled: false,
                    last_active: Date.now(),
                    last_notification_check: 0
                });

            } catch (error) {
                alert(`Registration Failed: ${error.message}`);
            }
        }

        function logout() {
            if (currentUserId) {
                database.ref(`edupro_users/${currentUserId}/last_active`).set(Date.now());
            }
            auth.signOut();
            showWelcomeScreen();
        }

        async function initiatePayment(courseId) {
            if (!currentUserId) return showLogin();
            if (!currentUser) await fetchUserData();

            const course = courses.find(c => c.id === courseId);
            const userEnrollment = currentUser.enrolled_courses ? currentUser.enrolled_courses[courseId] : null;

            if (userEnrollment && userEnrollment.status === true) {
                alert(`You are already enrolled and the ${course.title} course is ACTIVE!`);
                return;
            }

            if (userEnrollment && userEnrollment.status === false) {
                window.open(PAYMENT_LINK, '_blank');
                alert("Your enrollment is already PENDING confirmation. Redirecting to payment portal again.");
                return;
            }

            try {
                await database.ref(`edupro_users/${currentUserId}/enrolled_courses/${courseId}/day`).set(1);
                await database.ref(`edupro_users/${currentUserId}/enrolled_courses/${courseId}/status`).set(false);

                await fetchUserData();
                currentUser = users.find(u => u.uid === currentUserId);
                showCourseDetail(courseId);

                window.open(PAYMENT_LINK, '_blank');

                alert(`Payment initiated for ${course.title}. Your enrollment is PENDING confirmation. Please allow time for admin approval.`);

            } catch (error) {
                alert(`Failed to initiate enrollment: ${error.message}`);
            }
        }

        async function deleteUserPermanently(userId) {
            if (!isAdminLoggedIn) return;
            const userToDelete = users.find(u => u.uid === userId);
            if (!userToDelete) return;

            if (confirm(`ARE YOU SURE you want to permanently delete ALL data for user: ${userToDelete.name} (${userToDelete.email})? This action cannot be undone and will not be logged out in a real application!`)) {
                try {
                    await database.ref(`edupro_users/${userId}`).remove();

                    certificates.filter(c => c.userId === userId).forEach(async(cert) => {
                        await database.ref(`certificates/${cert.id}`).remove();
                    });

                    await fetchUserData();
                    renderAdminDashboard();
                    closeAdminUserDetails();
                    alert(`User ${userToDelete.name} and all associated data have been permanently deleted.`);

                } catch (error) {
                    console.error("Error deleting user:", error);
                    alert(`Failed to delete user: ${error.message}`);
                }
            }
        }

        async function toggleUserDisableStatus(userId) {
            if (!isAdminLoggedIn) return;
            const userToToggle = users.find(u => u.uid === userId);
            if (!userToToggle) return;

            const currentDisabledStatus = userToToggle.disabled || false;
            const newDisabledStatus = !currentDisabledStatus;

            try {
                await database.ref(`edupro_users/${userId}/disabled`).set(newDisabledStatus);

                await fetchUserData();
                renderAdminDashboard();
                showAdminUserDetails(userId);

                alert(`User ${userToToggle.name}'s account status changed to: ${newDisabledStatus ? 'DISABLED (Cannot Log In)' : 'ENABLED (Can Log In)'}`);

            } catch (error) {
                console.error("Error toggling disable status:", error);
                alert(`Failed to change disable status: ${error.message}`);
            }
        }


        // **************************************************
        // *** 5. RENDER FUNCTIONS (STUDENT) ***
        // **************************************************

        function renderCourseCard(course) {
            const userEnrollment = currentUser && currentUser.enrolled_courses ? currentUser.enrolled_courses[course.id] : null;
            const isEnrolled = userEnrollment && userEnrollment.status === true;
            const isPending = userEnrollment && userEnrollment.status === false;
            const isNotEnrolled = !userEnrollment;
            const isCertified = certificates.some(c => c.userId === currentUserId && c.courseId === course.id);


            let cardClasses = 'shadow-lg';
            let buttonText = 'View Details';

            if (currentUser) {
                if (isCertified) {
                    cardClasses = 'border-4 border-yellow-500 shadow-xl';
                    buttonText = 'View Certificate üèÜ';
                } else if (isEnrolled) {
                    cardClasses = 'border-4 border-green-500 shadow-xl';
                    buttonText = 'Open Course';
                } else if (isPending) {
                    cardClasses = 'border-4 border-orange-500 shadow-xl';
                    buttonText = 'Awaiting Confirmation';
                } else if (isNotEnrolled) {
                    buttonText = 'Enroll Now';
                }
            }

            return `
                <div class="card-hover bg-white p-6 rounded-xl ${cardClasses}">
                    <div class="text-3xl mb-3">${course.icon}</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${course.title}</h3>
                    <p class="text-gray-600 mb-4">${course.description}</p>
                    <div class="flex justify-between text-sm text-gray-500 mb-4">
                        <span>Level: ${course.level}</span>
                        <span>Duration: ${course.duration}</span>
                    </div>
                    <div class="flex items-center space-x-1 text-yellow-500 mb-4">
                        ${'‚òÖ'.repeat(Math.floor(course.rating))}
                        ${course.rating % 1 !== 0 ? '‚òÜ' : ''}
                        <span class="text-gray-600 ml-1">(${course.students} enrolled)</span>
                    </div>
                    <button onclick="showCourseDetail('${course.id}')" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        function loadPopularCourses() {
            const container = document.getElementById('popular-courses-preview');
            const popularCourses = courses.slice(0, 3);
            container.innerHTML = popularCourses.map(renderCourseCard).join('');
        }

        function renderCourseList(filteredCourses) {
            const container = document.getElementById('courses-container');
            container.innerHTML = filteredCourses.map(renderCourseCard).join('');
        }

        function filterCourses(category) {
            let filtered = courses;
            if (category !== 'all') {
                filtered = courses.filter(course => course.category === category);
            }
            renderCourseList(filtered);
            resetFilterButtons(category);
        }

        function resetFilterButtons(activeCategory) {
            document.querySelectorAll('.language-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.language-filter[onclick="filterCourses('${activeCategory}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        async function showCourseDetail(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;

            hideAllScreens();
            document.getElementById('course-detail').style.display = 'block';
            const container = document.getElementById('course-detail-content');
            container.setAttribute('data-course-id', courseId);

            const userEnrollment = currentUser && currentUser.enrolled_courses ? currentUser.enrolled_courses[courseId] : null;
            const isEnrolled = userEnrollment && userEnrollment.status === true;
            const isPending = userEnrollment && userEnrollment.status === false;
            const isNotEnrolled = !currentUser || !userEnrollment;
            const currentDay = userEnrollment ? userEnrollment.day : 1;
            const isCertified = certificates.some(c => c.userId === currentUserId && c.courseId === courseId);

            const totalDays = course.curriculum ? course.curriculum.length : 10;
            const curriculumPreviewHTML = course.curriculum ? course.curriculum.slice(0, 6).map(item => {
                const itemTitle = typeof item === 'object' && item.title ? item.title : 'Module';
                return `<li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> ${itemTitle}</li>`;
            }).join('') : `<li><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Modules TBD</li>`;

            const fullCurriculumHTML = course.curriculum ? course.curriculum.map((item, index) => {
                const day = index + 1;
                const dayTitle = typeof item === 'object' && item.title ? item.title : `Day ${day} Content`;

                const completed = isEnrolled && day < currentDay;
                const current = isEnrolled && day === currentDay;
                const statusIcon = completed ? '‚úÖ' : current ? 'üî•' : 'üîí';
                const statusColor = completed ? 'text-green-600' : current ? 'text-red-500' : 'text-gray-500';
                const isLockedVisual = !isEnrolled || (isEnrolled && day > currentDay);


                return `
                    <li class="p-4 border-b last:border-b-0 flex items-center justify-between ${isLockedVisual ? 'opacity-50' : ''}">
                        <span class="font-medium flex items-center">Day ${day}: ${dayTitle}</span>
                        <span class="${statusColor}">${statusIcon}</span>
                    </li>
                `;
            }).join('') : `<li class="p-4 text-gray-500 text-center">Curriculum details coming soon.</li>`;


            let actionButton;
            let enrollmentMessage;


            if (isCertified) {
                const certData = certificates.find(c => c.userId === currentUserId && c.courseId === courseId);
                actionButton = `<div class="space-y-3">
                        <button onclick="openExistingCertificate(certData)" class="w-full bg-yellow-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-yellow-700 transition-colors">
                            View Certificate üèÜ
                        </button>
                        <button onclick="startLearning('${course.id}')" class="w-full bg-indigo-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition-colors">
                            Open Course (Completed)
                        </button>
                    </div>`;
                enrollmentMessage = `<p class="text-center text-sm text-gray-500 mt-4">You have successfully completed this course and earned your certificate.</p>`;
            } else if (isEnrolled) {
                actionButton = `<button onclick="startLearning('${course.id}')" class="w-full bg-green-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition-colors">
                    Continue Learning (Day ${currentDay})
                </button>`;
                enrollmentMessage = `<p class="text-center text-sm text-gray-500 mt-4">You have full, lifetime access to this course.</p>`;

            } else if (isPending) {
                actionButton = `<div class="p-4 bg-orange-100 border border-orange-400 rounded-lg text-orange-800">
                    <p class="font-semibold mb-2">Enrollment is **PENDING** admin confirmation.</p>
                    <p class="text-sm">Please allow time for processing. Your status: <span class="font-bold">LOCKED (FALSE)</span></p>
                </div>`;
                enrollmentMessage = `<p class="text-center text-sm text-gray-500 mt-4">Check My Courses for status updates. <button onclick="window.open(PAYMENT_LINK, '_blank')" class="text-indigo-600 underline">View Payment Portal</button></p>`;

            } else if (isNotEnrolled && currentUser) {
                actionButton = `<button onclick="initiatePayment('${course.id}')" class="w-full bg-indigo-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition-colors shadow-xl">
                    Enroll Now - Pay Now
                </button>`;
                enrollmentMessage = `<p class="text-center text-sm text-gray-500 mt-4">Clicking above initiates enrollment (sets status to FALSE) and opens the payment portal.</p>`;

            } else {
                actionButton = `<button onclick="showLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition-colors shadow-xl">
                    Sign In to Enroll
                </button>`;
                enrollmentMessage = `<p class="text-center text-sm text-gray-500 mt-4">You must be logged in to enroll in this course.</p>`;
            }


            const html = `
                <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden p-8">
                    <div class="md:flex md:space-x-8">
                        <div class="md:w-2/3">
                            <h2 class="text-5xl font-extrabold text-gray-900 mb-3">${course.icon} ${course.title}</h2>
                            <p class="text-xl text-gray-600 mb-6">${course.description}</p>

                            <div class="flex items-center space-x-6 text-gray-700 mb-8">
                                <span class="flex items-center">
                                    <svg class="w-5 h-5 mr-1 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a5 5 0 00-5 5c0 1.05.176 2.05.51 3L10 16l4.49-3A5 5 0 0015 10a5 5 0 00-5-5z" clip-rule="evenodd"/></svg>
                                    ${course.level}
                                </span>
                                <span class="flex items-center">
                                    <svg class="w-5 h-5 mr-1 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/></svg>
                                    ${course.duration}
                                </span>
                                <span class="flex items-center text-yellow-500">
                                    ${'‚òÖ'.repeat(Math.floor(course.rating))}
                                    <span class="text-gray-600 ml-1">(${course.rating})</span>
                                </span>
                            </div>

                            <h3 class="text-3xl font-bold text-gray-800 mb-4">What you will learn (Preview):</h3>
                            <ul class="grid grid-cols-2 gap-4 text-gray-700">
                                ${curriculumPreviewHTML}
                            </ul>
                        </div>

                        <div class="md:w-1/3 mt-8 md:mt-0">
                            <div class="bg-gray-50 p-6 rounded-xl shadow-inner sticky top-24">
                                <h3 class="text-2xl font-bold text-gray-800 mb-4">Course Access</h3>
                                <p class="text-3xl font-extrabold text-indigo-600 mb-6">Course Fee: FREE*</p>
                                ${actionButton}
                                ${enrollmentMessage}
                            </div>
                        </div>
                    </div>

                    <div class="mt-12 pt-8 border-t border-gray-200">
                        <h3 class="text-3xl font-bold text-gray-800 mb-6">Full Curriculum (${totalDays} Days)</h3>
                        <ul class="bg-white border rounded-xl shadow-lg divide-y divide-gray-100">
                            ${fullCurriculumHTML}
                        </ul>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderProfileCourses() {
            const container = document.getElementById('enrolled-courses');
            container.innerHTML = '';

            if (!currentUser || !currentUser.enrolled_courses) {
                container.innerHTML = `<p class="text-gray-500 py-8">You are not currently enrolled in any courses. <button onclick="showCourseList()" class="text-indigo-600 hover:underline font-semibold">Browse courses</button> to get started!</p>`;
                return;
            }

            const enrolledCourses = currentUser.enrolled_courses;
            const enrolledCourseIds = Object.keys(enrolledCourses);
            const userCertificates = certificates.filter(c => c.userId === currentUserId);
            const activeEnrollments = enrolledCourseIds.filter(id => enrolledCourses[id].status === true || enrolledCourses[id].status === false);


            if (activeEnrollments.length === 0) {
                container.innerHTML = `<p class="text-gray-500 py-8">You are not currently enrolled in any courses. <button onclick="showCourseList()" class="text-indigo-600 hover:underline font-semibold">Browse courses</button> to get started!</p>`;
                return;
            }

            activeEnrollments.forEach(courseId => {
                        const course = courses.find(c => c.id === courseId);
                        const enrollment = enrolledCourses[courseId];

                        if (course && enrollment) {
                            const isEnrolled = enrollment.status === true;
                            const isPending = enrollment.status === false;

                            let actionButton;
                            let statusTag;
                            let cardClasses = 'border-t-4';
                            const hasCertificate = userCertificates.some(c => c.courseId === courseId);
                            const totalDays = course.curriculum ? course.curriculum.length : 10;


                            if (hasCertificate) {
                                const certData = userCertificates.find(c => c.courseId === courseId);
                                cardClasses += ' border-yellow-500';
                                statusTag = `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Certified</span>`;

                                // Action buttons for completed course
                                actionButton = `<div class="space-y-2">
                                <button onclick="showCertificateScreen(certificates.find(c => c.courseId === '${courseId}' && c.userId === currentUserId))" class="w-full bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700">View Certificate üèÜ</button>
                                <button onclick="startLearning('${courseId}')" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Open Course</button>
                            </div>`;

                            } else if (isEnrolled) {
                                const progress = Math.round((enrollment.day / totalDays) * 100);
                                const isComplete = progress === 100;

                                cardClasses += ' border-green-500';
                                statusTag = `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Active</span>`;

                                if (isComplete) {
                                    actionButton = `<button onclick="alert('Course completed! Contact admin for certificate issue.')" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Finished - Get Certificate üéì</button>`;
                                } else {
                                    actionButton = `<button onclick="startLearning('${courseId}')" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Continue Learning (Day ${enrollment.day})</button>`;
                                }
                            } else if (isPending) {
                                cardClasses += ' border-orange-500';
                                statusTag = `<span class="bg-orange-100 text-orange-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Pending Confirmation</span>`;
                                actionButton = `<button onclick="showCourseDetail('${courseId}')" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700">View Status</button>`;
                            }


                            container.innerHTML += `
                        <div class="card-hover bg-white p-6 rounded-xl shadow-lg w-full sm:w-80 ${cardClasses}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-3xl">${course.icon}</div>
                                ${statusTag}
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${course.title}</h3>
                            <p class="text-sm text-gray-600 mb-4">${course.description}</p>

                            ${isEnrolled && !hasCertificate ? `
                                <div class="mb-4">
                                    <div class="flex justify-between text-sm font-medium text-gray-700">
                                        <span>Progress:</span>
                                        <span>${Math.round((enrollment.day / totalDays) * 100)}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                        <div class="progress-bar bg-green-500 h-2.5 rounded-full" style="width: ${Math.round((enrollment.day / totalDays) * 100)}%"></div>
                                    </div>
                                </div>
                            ` : `<div class="h-10 mb-4"></div>`}

                            ${actionButton}
                        </div>
                    `;
                }
            });
        }

        function renderCertificates() {
            const container = document.getElementById('certificates-container');
            container.innerHTML = '';

            const userCertificates = certificates.filter(c => c.userId === currentUserId);

            if (userCertificates.length === 0) {
                container.innerHTML = `<p class="text-gray-500 py-8 text-center w-full">You have not completed any courses yet. Keep learning!</p>`;
                return;
            }

            userCertificates.forEach(cert => {
                const course = courses.find(c => c.id === cert.courseId);
                if (course) {
                    container.innerHTML += `
                        <div class="card-hover bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500 text-center">
                            <div class="text-5xl mb-3">üéì</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">${course.title}</h3>
                            <p class="text-gray-600 mb-3">Certificate of Completion</p>
                            <p class="text-sm text-gray-500 mb-4">Awarded on: ${cert.dateDisplay}</p>
                            <button onclick="showCertificateScreen(certificates.find(c => c.id === '${cert.id}'))" class="w-full bg-yellow-500 text-gray-900 py-2 rounded-lg hover:bg-yellow-600 transition-colors font-semibold">
                                View Certificate
                            </button>
                        </div>
                    `;
                }
            });
        }

        function renderDashboard() {
            if (!currentUser) {
                document.getElementById('dashboard-user-name').textContent = "Guest";
                return;
            }

            document.getElementById('dashboard-user-name').textContent = currentUser.name.split(' ')[0];

            const enrolledCourses = currentUser.enrolled_courses || {};
            const userCertificates = certificates.filter(c => c.userId === currentUserId);

            const totalEnrolled = Object.keys(enrolledCourses).length;
            const completedCount = userCertificates.length;

            const activeEnrollmentIds = Object.keys(enrolledCourses).filter(id => enrolledCourses[id].status === true);
            const activeCourses = activeEnrollmentIds.map(courseId => {
                const course = courses.find(c => c.id === courseId);
                return course ? { ...course, enrollment: enrolledCourses[courseId] } : null;
            }).filter(c => c !== null);

            document.getElementById('enrolled-count').textContent = totalEnrolled;
            document.getElementById('completed-count').textContent = completedCount;
            document.getElementById('certificates-count').textContent = completedCount;

            const continueLearningContainer = document.getElementById('continue-learning');
            continueLearningContainer.innerHTML = '';

            if (activeCourses.length === 0) {
                continueLearningContainer.innerHTML = `<p class="text-gray-500 py-4">You are not actively enrolled in any courses yet. Enroll now or wait for admin approval!</p>`;
                return;
            }

            activeCourses.forEach(course => {
                const enrollment = course.enrollment;
                const totalDays = course.curriculum ? course.curriculum.length : 10;
                const progressDay = enrollment.day || 1;
                const progress = Math.round((progressDay / totalDays) * 100);
                const isComplete = progress === 100;

                if (userCertificates.some(c => c.courseId === course.id)) return;

                continueLearningContainer.innerHTML += `
                    <div class="p-4 border rounded-xl shadow-sm hover:shadow-md transition-shadow cursor-pointer border-indigo-200" onclick="startLearning('${course.id}')">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-900 flex items-center">${course.icon} ${course.title}</h4>
                            <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2 py-1 rounded-full">Day ${progressDay} of ${totalDays}</span>
                        </div>
                        <p class="text-sm text-gray-500">Progress: ${progress}%</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                            <div class="progress-bar bg-green-500 h-2 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            });

            if (continueLearningContainer.innerHTML.trim() === '') {
                continueLearningContainer.innerHTML = `<p class="text-gray-500 py-4">üéâ You've completed all active courses! View your certificates or browse new courses.</p>`;
            }
        }
        function renderMyAccount() {
            const container = document.getElementById('my-account-details-container');
            container.innerHTML = '';

            if (!currentUser) {
                container.innerHTML = `<p class="text-red-500">Error: User data is not available. Please log in again.</p>`;
                return;
            }

            const DetailRow = (label, value) => `
                <div class="detail-row py-3">
                    <span class="text-lg font-medium text-gray-600">${label}:</span>
                    <span class="text-lg font-semibold text-gray-900">${value}</span>
                </div>
            `;

            const userCertificates = certificates.filter(c => c.userId === currentUserId);
            const enrolledCount = Object.keys(currentUser.enrolled_courses || {}).length;
            const completedCount = userCertificates.length;
            const status = currentUser.disabled ? 'Disabled by Admin' : 'Active';

            container.innerHTML = `
                ${DetailRow('Full Name (Certificate Name)', currentUser.name)}
                ${DetailRow('Email Address', currentUser.email)}
                ${DetailRow('Phone Number', currentUser.phone || 'N/A')}
                ${DetailRow('Joined Date', currentUser.joined)}
                <div class="detail-row py-3">
                    <span class="text-lg font-medium text-gray-600">Account Status:</span>
                    <span class="text-lg font-semibold ${currentUser.disabled ? 'text-red-600' : 'text-green-600'}">${status}</span>
                </div>
                ${DetailRow('Total Enrolled Courses', enrolledCount)}
                ${DetailRow('Total Certificates Earned', completedCount)}
            `;
        }

        // **************************************************
        // *** 6. ADMIN DASHBOARD UTILITIES ***
        // **************************************************

        async function toggleCourseStatus(userId, courseId, currentStatus) {
            if (!isAdminLoggedIn) return;
            const newStatus = currentStatus === 'false' ? true : false;
            try {
                await database.ref(`edupro_users/${userId}/enrolled_courses/${courseId}/status`).set(newStatus);
                await fetchUserData();
                renderAdminDashboard();
                alert(`Status for ${getCourseTitle(courseId)} for user ${users.find(u => u.uid === userId)?.name} updated to ${newStatus ? 'TRUE (ACTIVE)' : 'FALSE (PENDING)'}`);
            } catch (error) {
                console.error("Error toggling course status:", error);
                alert(`Failed to update status: ${error.message}`);
            }
        }

        async function sendGlobalNotification(event) {
            event.preventDefault();
            const message = document.getElementById('notification-input').value;
            if (!message) return;

            const notificationData = {
                message: message,
                timestamp: Date.now()
            };

            try {
                // Set the message in the Firebase notifications node
                await database.ref('edupro_notifications').set(notificationData);
                globalNotification = notificationData;
                alert('Notification broadcasted successfully!');
                document.getElementById('notification-input').value = '';
                document.getElementById('current-global-notification').textContent = message;

            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Failed to send notification.');
            }
        }

        function renderAdminDashboard() {
            if (!isAdminLoggedIn) return;
            const distributionData = getCourseEnrollmentDistributionData();
            document.getElementById('metric-total-students').textContent = users.length;
            document.getElementById('metric-total-certificates').textContent = certificates.length;
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            document.getElementById('metric-total-active-users').textContent = distributionData.totalActiveUsers;
            document.getElementById('metric-approvals').textContent = distributionData.totalApprovals;
            document.getElementById('metric-revokes').textContent = distributionData.totalRevokes;
            const ctx = document.getElementById('courseChart').getContext('2d');
            if (courseChartInstance) {
                courseChartInstance.destroy();
            }
            courseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: distributionData.labels,
                    datasets: [{
                        label: 'Total Enrolled (Active or Pending)',
                        data: distributionData.enrolledData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Certified (Completed)',
                        data: distributionData.certifiedData,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    }
                }
            });
            const courseFilter = document.getElementById('admin-course-filter');
            courseFilter.innerHTML = '<option value="all">All Courses</option>';
            courses.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.title;
                courseFilter.appendChild(option);
            });
            renderAdminStudentTable();
            document.getElementById('admin-student-search').oninput = renderAdminStudentTable;
            document.getElementById('admin-course-filter').onchange = renderAdminStudentTable;
            document.getElementById('admin-status-filter').onchange = renderAdminStudentTable;
            document.getElementById('admin-online-filter').onchange = renderAdminStudentTable;
        }

        function renderAdminStudentTable() {
            const tableBody = document.getElementById('admin-table-body');
            const noResults = document.getElementById('admin-no-results');
            const nextPageBtn = document.getElementById('next-page-btn');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const paginationInfo = document.getElementById('pagination-info');

            tableBody.innerHTML = '';

            const searchTerm = document.getElementById('admin-student-search').value.toLowerCase();
            const filterCourseId = document.getElementById('admin-course-filter').value;
            const filterStatus = document.getElementById('admin-status-filter').value;
            const filterOnline = document.getElementById('admin-online-filter').value;

            const allEnrollmentRecords = [];
            users.forEach(user => {
                const userEnrollments = user.enrolled_courses || {};
                Object.keys(userEnrollments).forEach(courseId => {
                    allEnrollmentRecords.push({
                        userId: user.uid,
                        userName: user.name,
                        userEmail: user.email,
                        userPhone: user.phone || '',
                        lastActive: user.last_active,
                        joined: user.joined,
                        courseId: courseId,
                        courseTitle: getCourseTitle(courseId),
                        status: userEnrollments[courseId].status
                    });
                });
            });

            const filteredRecords = allEnrollmentRecords.filter(record => {
                if (searchTerm && !record.userName.toLowerCase().includes(searchTerm) && !record.userEmail.toLowerCase().includes(searchTerm) && !record.userPhone.includes(searchTerm)) {
                    return false;
                }
                if (filterCourseId !== 'all' && record.courseId !== filterCourseId) {
                    return false;
                }
                if (filterStatus === 'true' && record.status !== true) {
                    return false;
                }
                if (filterStatus === 'false' && record.status !== false) {
                    return false;
                }
                const isOnline = isUserOnline(record.lastActive);
                if (filterOnline === 'online' && !isOnline) {
                    return false;
                }
                if (filterOnline === 'offline' && isOnline) {
                    return false;
                }

                return true;
            });

            const pendingRecords = filteredRecords.filter(r => r.status === false);
            const activeRecords = filteredRecords.filter(r => r.status === true);

            pendingRecords.sort((a, b) => new Date(a.joined) - new Date(b.joined));
            activeRecords.sort((a, b) => new Date(a.joined) - new Date(b.joined));

            const finalSortedRecords = pendingRecords.concat(activeRecords);
            const totalRecords = finalSortedRecords.length;

            const startIndex = (currentPage - 1) * RECORDS_PER_PAGE;
            const endIndex = Math.min(startIndex + RECORDS_PER_PAGE, totalRecords);
            const recordsToDisplay = finalSortedRecords.slice(startIndex, endIndex);

            paginationInfo.textContent = `Displaying ${totalRecords > 0 ? startIndex + 1 : 0}-${endIndex} of ${totalRecords} records`;
            nextPageBtn.style.display = endIndex < totalRecords ? 'block' : 'none';
            prevPageBtn.style.display = currentPage > 1 ? 'block' : 'none';


            if (recordsToDisplay.length === 0 && totalRecords > 0) {
                currentPage = 1;
                renderAdminStudentTable();
                return;
            } else if (recordsToDisplay.length === 0) {
                noResults.style.display = 'block';
                nextPageBtn.style.display = 'none';
                prevPageBtn.style.display = 'none';
                currentPage = 1;
            } else {
                noResults.style.display = 'none';
                recordsToDisplay.forEach(record => {
                    const statusText = record.status ? 'ACTIVE (TRUE)' : 'PENDING (FALSE)';
                    const statusClass = record.status ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';

                    const isOnline = isUserOnline(record.lastActive);
                    const onlineStatusTag = isOnline
                        ? `<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Online</span>`
                        : `<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Offline</span>`;

                    let actionButton;

                    if (!record.status) {
                        actionButton = `<button onclick="toggleCourseStatus('${record.userId}', '${record.courseId}', 'false')"
                                             class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs hover:bg-blue-700 transition-colors">
                                             APPROVE
                                           </button>`;
                    } else {
                        actionButton = `<button onclick="toggleCourseStatus('${record.userId}', '${record.courseId}', 'true')"
                                             class="bg-gray-400 text-white px-4 py-2 rounded-lg text-xs hover:bg-gray-500 transition-colors">
                                             Revoke
                                           </button>`;
                    }

                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.userName} ${onlineStatusTag}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.userEmail}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">${record.courseTitle}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm flex space-x-2">
                                ${actionButton}
                                <button onclick="showAdminUserDetails('${record.userId}')"
                                             class="bg-purple-600 text-white px-4 py-2 rounded-lg text-xs hover:bg-purple-700 transition-colors">
                                             Profile
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
        }

        function showAdminUserDetails(userId) {
            if (!isAdminLoggedIn) return;
            const modal = document.getElementById('admin-user-details-modal');
            const user = users.find(u => u.uid === userId);

            if (!user) {
                alert("User data not found.");
                return;
            }

            modal.style.display = 'flex';
            modal.setAttribute('data-user-id', userId);

            const userCertificates = certificates.filter(c => c.userId === userId);
            const enrolledCourses = user.enrolled_courses || {};
            const enrolledCourseIds = Object.keys(enrolledCourses);
            const enrolledCount = enrolledCourseIds.length;
            const completedCount = userCertificates.length;


            const modalUserName = document.getElementById('modal-user-name');
            const infoContainer = document.getElementById('modal-user-info');

            if (modalUserName) modalUserName.textContent = user.name;

            const disableBtn = document.getElementById('disable-user-btn');
            const currentDisabledStatus = user.disabled || false;
            disableBtn.textContent = currentDisabledStatus ? '‚úÖ ENABLE User' : 'üö´ DISABLE User';

            disableBtn.className = `px-4 py-2 rounded-lg text-sm transition-colors flex-1 shadow-md font-semibold ${currentDisabledStatus
                ? 'bg-green-600 hover:bg-green-700 text-white'
                : 'bg-yellow-500 hover:bg-yellow-600 text-gray-900'
                }`;

            const DetailRow = (label, value, colorClass = 'text-gray-900', isMonospace = false) => `
                <div class="detail-row">
                    <span class="text-sm font-medium text-gray-500">${label}:</span>
                    <span class="text-sm font-semibold ${colorClass} ${isMonospace ? 'font-mono text-xs' : ''} break-all">${value}</span>
                </div>
            `;


            infoContainer.innerHTML = `
                ${DetailRow('UID', user.uid, 'text-indigo-700', true)}
                ${DetailRow('Email', user.email)}
                ${DetailRow('Phone', user.phone || 'N/A')}
                ${DetailRow('Joined Date', user.joined)}
                ${DetailRow('Last Active', `${new Date(user.last_active).toLocaleString()} (${isUserOnline(user.last_active) ? 'Online' : 'Offline'})`)}
                ${DetailRow('Enrolled / Certified', `${enrolledCount} / ${completedCount}`, 'text-indigo-600')}
                <div class="p-2 mt-3 rounded-lg text-center font-extrabold ${currentDisabledStatus ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                    ACCOUNT STATUS: ${currentDisabledStatus ? 'DISABLED (Locked)' : 'ENABLED (Active)'}
                </div>
            `;

            const courseListContainer = document.getElementById('modal-course-list');
            courseListContainer.innerHTML = '';

            document.getElementById('modal-enrolled-count').textContent = enrolledCount;

            if (enrolledCourseIds.length === 0) {
                courseListContainer.innerHTML = '<p class="text-gray-500 p-4 text-center bg-gray-100 rounded-lg">No enrollments found for this user.</p>';
            } else {
                enrolledCourseIds.forEach(courseId => {
                    const course = courses.find(c => c.id === courseId);
                    const enrollment = enrolledCourses[courseId];

                    if (course) {
                        const isEnrolled = enrollment.status === true;
                        const statusColor = isEnrolled ? 'bg-green-500 text-white' : 'bg-orange-500 text-white';
                        const statusText = isEnrolled ? 'Active' : 'Pending';
                        const totalDays = course.curriculum ? course.curriculum.length : 10;
                        const progress = Math.round(((enrollment.day || 1) / totalDays) * 100);
                        const isCertified = userCertificates.some(c => c.courseId === courseId);

                        const enrollmentActionButton = isEnrolled
                            ? `<button onclick="toggleCourseStatus('${userId}', '${courseId}', 'true'); showAdminUserDetails('${userId}')" class="bg-gray-400 text-white px-3 py-1 text-xs rounded-lg hover:bg-gray-500 transition-colors shadow-sm font-medium">Revoke</button>`
                            : `<button onclick="toggleCourseStatus('${userId}', '${courseId}', 'false'); showAdminUserDetails('${userId}')" class="bg-blue-600 text-white px-3 py-1 text-xs rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-medium">Approve</button>`;

                        const certificateButton = isCertified
                            ? `<span class="bg-yellow-500 text-gray-900 px-3 py-1 text-xs font-bold rounded-lg ml-2 shadow-sm">Certified üèÜ</span>`
                            : '';

                        courseListContainer.innerHTML += `
                            <div class="course-item-admin border border-indigo-100 p-4 rounded-xl bg-white shadow-sm">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-indigo-700">${course.icon} ${course.title}</h4>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full ${statusColor}">${statusText}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="progress-bar bg-indigo-500 h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <div class="flex justify-between items-center text-xs text-gray-600 mt-2 pt-2 border-t border-gray-100">
                                    <span class="font-medium">Day ${enrollment.day || 1} of ${totalDays} (${progress}%)</span>
                                    <div class="flex items-center space-x-2">
                                        ${certificateButton}
                                        ${enrollmentActionButton}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }
        }

        // Add this function inside your existing <script> tags:

        async function downloadCurrentCertificate(format) {
            const certContainer = document.getElementById('certificate-content');
            const userName = certContainer.getAttribute('data-user-name') || 'Student';
            const courseTitle = certContainer.getAttribute('data-course-title') || 'Course';
            const refNo = certContainer.getAttribute('data-ref') || 'CERT00';
            const fileName = `${userName.replace(/ /g, '_')}_${courseTitle.replace(/ /g, '_')}_${refNo}.${format.toLowerCase()}`;

            // Temporarily hide the watermark and adjust scaling for better quality
            const watermark = document.querySelector('#certificate-content .watermark');
            if (watermark) watermark.style.display = 'none';

            showLoader(); // Show global loader during processing

            try {
                const canvas = await html2canvas(certContainer, {
                    scale: 2, // Use scale 2 for high resolution output
                    useCORS: true,
                    allowTaint: true,
                    scrollY: -window.scrollY, // Correctly handle scroll position
                    windowWidth: document.documentElement.offsetWidth,
                    windowHeight: document.documentElement.offsetHeight
                });

                const image = canvas.toDataURL(`image/${format.toLowerCase()}`);
                const link = document.createElement('a');

                if (format.toLowerCase() === 'png') {
                    link.href = image;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                // Note: The PDF logic needs updating, but the current PDF function is elsewhere.
                // The original PDF function is still in Section 6.
                else if (format.toLowerCase() === 'pdf') {
                    // Re-run the existing PDF logic to ensure it works
                    downloadCertificate('pdf');
                }

            } catch (error) {
                console.error("Error generating certificate image:", error);
                alert("Failed to download certificate. Check browser console for details.");
            } finally {
                // Restore watermark and hide loader
                if (watermark) watermark.style.display = 'block';
                hideLoader();
            }
        }

        function closeAdminUserDetails() {
            document.getElementById('admin-user-details-modal').style.display = 'none';
            document.getElementById('admin-user-details-modal').removeAttribute('data-user-id');
        }

        // **************************************************
        // *** 7. GLOBAL INITIALIZATION CALL ***
        // **************************************************

        initializeUI();
    </script>

</body>

</html>